# Тон-маппинг

В данном задании вам предстоит развить свои навыки GPGPU программирования, при желании познакомится с теорией цвета и добавить в ваш рендерер тон-маппинг.

## Перед началом

1. Скопируйте в эту папку любой рендерер уже рисующий что-то, аналогично предыдущим заданиям.
   В идеале он должен включать в себя все релевантные предыдущие домашки.
2. По возможности прочитайте [краткое объяснение](https://computergraphics.stackexchange.com/a/10318) того, что такое цветовые пространства, гамма-коррекция и тон-маппинг.

## Задание

#### Шаг 1

Поменяйте ваш рендерер чтобы он
1. использовал картинку формата `B10G11R11_UFLOAT` при рендеринге;
2. переносил контент этой картинки в `R8G8B8`-бэкбуфер при помощи пиксельного шейдера, просто квантующего диапазон $[0, 1]$ на $256$ значений и ограничивающего значения больше $1$ (нужно ли вообще писать какой-то код чтобы получить такое поведение в шейддере?).

В данном контексте картинку формата `B10G11R11_UFLOAT` будем называть HDR-изображением (high dynamic range), бэкбуфер LDR-изображением (low dynamic range), а шейдер переносящий его контент в бэкбуфер будем называть шейдером пост-обработки.

#### Шаг 2

Добавьте в шейдер пост-обработки "наивный" тон-маппинг.
Высчитайте по HDR изображению его экспозицию и используйте её чтобы при переходе в LDR изображение потерять как можно меншье точности на текущем кадре.
Для этого:

1. напишите компьют-шейдер который посчитает минимум и максимум уровней освещённости в исходном изображении;
2. напишите компьют-шейдер, который посчитает гистограмму плотности распределения логарифмов (почему?) уровней освещённости пикселей HDR-изображения с $\approx 100$ уровнями квантизации, распределёнными равномерно от минимума до максимума;
3. выберите основываясь на истограмме экспозицию для текущего кадраю (как? медиана, среднее, квантиль?);
4. модифицируйте шейдер пост-эффектов чтобы он использовал экспозицию при переводи изображения в LDR;
5. придумайте, как сделать, чтобы тонмапинг был не так чуствителен к малейшему изменению угла камеры и не вызывала у пользователей эпилепсию.

За использование shared memory для накопления локальных результатов в рамках группы тредов полагаются дополнительные баллы.
Однако лучше реализовать оба варианта и сравнить профайлером время исполнения, использовать shared memory не всегда быстрее чем не использовать.
Если в вашем приложении будет возможность включить/отключить shared memory (например при помощи ImGui) и сравнить результаты, это даст ещё больше баллов.

Подумайте, что в здесь имеется в виду под яркостью.
Есть ли у яркости понятное представление в цветовой модели RGB?
А в других цветовых моделях?

Нужно ли менять значение auto-gamma в инициализации этны?

### Наставление

Ваша главная цель -- сделать красиво.
Если то, что вы закодили, выглядит некрасиво, значит домашку вы ещё не доделали.
В связи с этим рекомендуется найти в интернете какую-нибудь кубмапу и натянуть её в качестве скайбокса чтобы чёрный фон не портил результат, а также натянуть хоть как-то текстуры на вашу геометрию.

## Полезные материалы

1. https://computergraphics.stackexchange.com/a/10318 &mdash; неплохое объяснение цветовых пространств "на пальцах"
2. https://cdn.fastly.steamstatic.com/apps/valve/2008/GDC2008_PostProcessingInTheOrangeBox.pdf &mdsah; как тонмаппинг делался в Half Life 2
3. https://bartwronski.com/2022/02/28/exposure-fusion-local-tonemapping-for-real-time-rendering/ &mdash; совсем крутой тонмаппинг, использующийся в Dagor
